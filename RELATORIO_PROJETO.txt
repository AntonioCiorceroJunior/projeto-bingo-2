RELATÓRIO TÉCNICO EXAUSTIVO DO PROJETO BINGO ADMIN
====================================================
Data de Geração: 24/05/2024
Versão do Documento: 4.0 (Análise Completa de Código Fonte)

1. VISÃO GERAL DO SISTEMA
-------------------------
O Bingo Admin é uma aplicação Desktop desenvolvida em .NET 8 utilizando WPF (Windows Presentation Foundation) para a interface gráfica. O sistema adota a arquitetura MVVM (Model-View-ViewModel) adaptada, com injeção de dependência e separação clara de responsabilidades em camadas (Domain, Infra, UI).

Tecnologias Principais:
- Framework: .NET 8
- UI: WPF (XAML + C#)
- Banco de Dados: SQLite
- ORM: Entity Framework Core 8
- Relatórios: QuestPDF
- Injeção de Dependência: Microsoft.Extensions.DependencyInjection

2. ESTRUTURA DE ARQUIVOS E PASTAS
---------------------------------
A solução está dividida em três projetos principais:

A. BingoAdmin.Domain (Núcleo da Lógica de Negócio)
   - /Entities: Contém as classes que representam as tabelas do banco e objetos de negócio.
   - /Services: Contém serviços puros de domínio (ex: algoritmos matemáticos).

B. BingoAdmin.Infra (Acesso a Dados)
   - /Data: Contexto do EF Core e configurações de banco.
   - /Migrations: Histórico de versionamento do esquema do banco.

C. BingoAdmin.UI (Interface e Orquestração)
   - /Services: Serviços de aplicação que conectam a UI ao Domain/Infra.
   - /Views: Telas do sistema (XAML + Code-behind).
   - /Converters: Conversores de valor para Data Binding do WPF.
   - App.xaml: Ponto de entrada e configuração de DI.

3. ANÁLISE DETALHADA - CAMADA DOMAIN (ENTIDADES)
------------------------------------------------
Esta camada define a estrutura de dados e as regras de negócio fundamentais.

3.1. Entidade: Bingo
   - Arquivo: Bingo.cs
   - Função: Representa um evento de bingo completo.
   - Propriedades:
     - Id (PK)
     - Nome (string): Nome do evento.
     - DataInicioPrevista (DateTime).
     - QuantidadeCombos (int): Total de jogadores/combos.
     - CartelasPorCombo (int): Quantas cartelas cada jogador tem.
     - QuantidadeRodadas (int).
     - ModoPadroesDinamicos (bool): Flag que ativa o modo onde padrões mudam durante o jogo.
     - Status (string): "Rascunho", "Ativo", "Concluido".
   - Relacionamentos: 1:N com Combos, 1:N com Rodadas, 1:N com BingoPadroes.

3.2. Entidade: Cartela
   - Arquivo: Cartela.cs
   - Função: Representa uma única cartela de 5x5 números.
   - Propriedades:
     - Id (PK)
     - BingoId (FK), ComboId (FK).
     - NumeroCartelaNoCombo (int): Índice sequencial dentro do combo (1, 2, 3...).
     - GridNumeros (string): String contendo os 25 números separados por vírgula (ex: "1,15,30...").
   - Lógica Crítica: A propriedade GridNumeros é a fonte da verdade para a verificação de vitória.

3.3. Entidade: Combo
   - Arquivo: Combo.cs
   - Função: Agrupamento de cartelas pertencentes a um único jogador.
   - Propriedades:
     - Id (PK), BingoId (FK).
     - NumeroCombo (int): Identificador legível para o usuário.
     - NomeDono (string): Nome do jogador.
     - CodigoValidacao (string): Código único para segurança.
   - Relacionamentos: 1:N com Cartelas.

3.4. Entidade: Rodada
   - Arquivo: Rodada.cs
   - Função: Representa uma partida valendo prêmio dentro do evento.
   - Propriedades:
     - Id (PK), BingoId (FK).
     - NumeroOrdem (int): Sequência da rodada (1ª, 2ª...).
     - PadraoId (FK): Padrão de vitória (ex: Cartela Cheia).
     - Status (string): "NaoIniciada", "EmAndamento", "Encerrada".
     - EhRodadaExtra (bool): Indica se foi criada ad-hoc durante o jogo.
   - Relacionamentos: 1:N com Ganhadores.

3.5. Entidade: Padrao
   - Arquivo: Padrao.cs
   - Função: Define a regra geométrica para ganhar.
   - Propriedades:
     - Id (PK).
     - Nome (string): Ex: "Linha Horizontal", "X".
     - Mascara (string): String de 25 caracteres ('0' ou '1') mapeando as posições necessárias.
     - IsPredefinido (bool): Protege padrões do sistema contra exclusão.
   - Lógica Especial: Suporta máscaras "RANDOM:X" para padrões do tipo "X acertos em qualquer lugar".

3.6. Entidade: BingoPadrao
   - Arquivo: BingoPadrao.cs
   - Função: Tabela de junção para o "Modo Padrões Dinâmicos".
   - Propriedades:
     - BingoId (FK), PadraoId (FK).
     - FoiSorteado (bool): Indica se este padrão já saiu na rodada atual (controle de estado).

3.7. Entidade: Ganhador
   - Arquivo: Ganhador.cs
   - Função: Registra quem bateu o bingo em uma rodada.
   - Propriedades:
     - Id (PK), RodadaId (FK), CartelaId (FK).
     - IsVencedorFinal (bool): Usado após desempate para marcar quem levou o prêmio.

3.8. Entidade: Sorteio
   - Arquivo: Sorteio.cs
   - Função: Armazena o estado do globo/sorteio de uma rodada.
   - Propriedades:
     - RodadaId (FK).
     - BolasSorteadas (string): CSV dos números já sorteados (ex: "5,12,66").
     - DataHoraInicio (DateTime).

3.9. Entidades de Desempate (PedraMaiorSorteio, DesempateItem)
   - Função: Gerenciam a lógica de "Pedra Maior" quando há múltiplos ganhadores.
   - PedraMaiorSorteio: Histórico de cada "pedra" tirada por um jogador no desempate.
   - DesempateItem: Snapshot do estado atual do desempate para a UI.

4. ANÁLISE DETALHADA - CAMADA DOMAIN (SERVICES)
-----------------------------------------------

4.1. BingoService (Algoritmo de Geração)
   - Arquivo: BingoService.cs
   - Método `GerarCombos`:
     - Responsável pela criação massiva de cartelas.
     - Utiliza um `HashSet<string>` global para garantir que NENHUMA cartela no bingo inteiro seja igual a outra.
   - Método `GerarUmaCartela`:
     - Implementa as regras clássicas do Bingo:
       - Coluna B: 1-15 (5 números)
       - Coluna I: 16-30 (5 números)
       - Coluna N: 31-45 (4 números + espaço livre/zero no meio)
       - Coluna G: 46-60 (5 números)
       - Coluna O: 61-75 (5 números)
     - Retorna a string formatada para persistência.

5. ANÁLISE DETALHADA - CAMADA UI (SERVICES)
-------------------------------------------
Estes serviços orquestram a lógica da aplicação e mantêm o estado em memória durante a execução.

5.1. GameService (Motor do Jogo)
   - Arquivo: GameService.cs
   - Estado: Mantém em memória `_cachedCartelas` (todas as cartelas do bingo) para performance extrema durante o sorteio.
   - Método `IniciarRodada`: Carrega o estado do banco, incluindo padrões dinâmicos se ativados.
   - Método `SortearNumero`:
     1. Gera número aleatório (1-75) não repetido.
     2. Adiciona à lista de sorteados.
     3. Chama `VerificarGanhadores`.
   - Método `VerificarGanhadores`:
     - Itera sobre TODAS as cartelas em memória.
     - Aplica a máscara do padrão atual (ou lista de padrões dinâmicos) sobre os números da cartela.
     - Se `VerificarMascara` retornar true, dispara evento `OnGanhadoresEncontrados`.
   - Lógica de Padrões Dinâmicos:
     - Se ativo, verifica a cartela contra TODOS os padrões não sorteados da lista.
     - Se um padrão é atingido, ele é marcado como `FoiSorteado` e removido da lista de verificação ativa, permitindo múltiplos ganhadores em padrões diferentes na mesma rodada.

5.2. BingoManagementService
   - Arquivo: BingoManagementService.cs
   - Função: CRUD de Bingos.
   - Destaque: Executa a geração de cartelas (`BingoService.GerarCombos`) em uma Task separada para não congelar a UI durante a criação de milhares de registros.

5.3. DesempateService
   - Arquivo: DesempateService.cs
   - Função: Controla o mini-game de "Pedra Maior".
   - Lógica: Sorteia números de 1 a 100 para cada ganhador empatado. Persiste o resultado e define o `IsVencedorFinal`.

5.4. PadraoService
   - Arquivo: PadraoService.cs
   - Função: Gerencia o catálogo de padrões.
   - Método `SeedPadroesIniciais`: Garante que padrões clássicos (Linha, Cruz, X, Cheia) existam no banco ao iniciar.

5.5. RelatorioService
   - Arquivo: RelatorioService.cs
   - Tecnologia: QuestPDF.
   - Função: Gera PDF detalhado com resumo do evento, lista de ganhadores por rodada e estatísticas.

5.6. FeedService
   - Arquivo: FeedService.cs
   - Função: Gerencia o log de atividades centralizado do sistema.
   - Características:
     - Singleton: Mantém o estado do feed entre trocas de tela.
     - Histórico Persistente: Carrega logs antigos baseados no Bingo selecionado.
     - Formatação: Suporta mensagens com títulos, timestamps e tipos (Info, Warning, Error).
     - Interatividade: Suporta expansão de mensagens longas na UI.

5.7. BingoContextService
   - Arquivo: BingoContextService.cs
   - Função: Gerencia o estado global de seleção do Bingo.
   - Padrão Observer: Dispara eventos `OnBingoChanged` para que todas as Views (Game, Financeiro, Relatórios) sincronizem automaticamente quando o usuário troca o Bingo no topo da tela.

5.8. GameStatusService
   - Arquivo: GameStatusService.cs
   - Função: Mantém o estado em tempo real dos elementos visuais do jogo que precisam ser acessados fora da GameView.
   - Propriedades:
     - Timers: Texto e progresso para contagem regressiva e sorteio automático.
     - RecentBalls: Lista observável dos últimos 20 números sorteados para exibição no Dashboard.
   - Implementação: `INotifyPropertyChanged` para atualização reativa da UI.

6. ANÁLISE DETALHADA - CAMADA UI (VIEWS)
----------------------------------------

6.1. GameView (Tela de Jogo)
   - Arquivo: GameView.xaml / .cs
   - Componentes:
     - Tabuleiro (Grid 1-75): Atualizado via Binding `ObservableCollection`.
     - Lista de Ganhadores: Exibe em tempo real quem bateu.
     - Controles: Botões Iniciar, Sortear, Pausar.
   - Integração: Alimenta o `GameStatusService` com atualizações de timer e bolas sorteadas.

6.2. DashboardView (Layout Principal)
   - Arquivo: DashboardView.xaml / .cs
   - Função: Container principal que abriga o menu lateral (Feed) e a área de conteúdo (Tabs).
   - Painel Lateral (Sidebar):
     - Seção 1: Status do Jogo (Cronômetros visuais).
     - Seção 2: Últimos Sorteios (Faixa horizontal com as últimas bolas: "B | 4").
     - Seção 3: Controles do Feed (Limpar, Histórico).
     - Seção 4: Feed de Atividades (Lista rolável com itens expansíveis).

6.3. BingoConfigView (Configuração)
   - Arquivo: BingoConfigView.xaml / .cs
   - Funcionalidade: Formulário para criar novos eventos.
   - Destaque: Checkbox "Modo Padrões Dinâmicos" habilita a seleção múltipla de padrões na lista.

6.3. App.xaml.cs (Inicialização)
   - Configura o container de Injeção de Dependência (`ServiceProvider`).
   - Registra: `BingoContext` (Scoped), Services (Transient/Scoped), Views (Transient).
   - Executa migrações de banco de dados e correções de esquema (ex: `DesempateItens`) na inicialização.

7. FLUXOS DE DADOS CRÍTICOS
---------------------------

A. Fluxo de Sorteio e Verificação:
   1. Usuário clica em "Sortear" na `GameView`.
   2. `GameView` chama `GameService.SortearNumero()`.
   3. `GameService` escolhe o número e salva no `Sorteio` (Banco).
   4. `GameService` itera sobre `_cachedCartelas` (Memória RAM).
   5. Para cada cartela, compara os números marcados com a `Mascara` do padrão.
   6. Se Match: Cria `GanhadorInfo`, salva `Ganhador` no banco, dispara evento.
   7. `GameView` recebe evento e adiciona nome na lista visual.

B. Fluxo de Padrões Dinâmicos:
   1. Na criação do Bingo, usuário seleciona N padrões (ex: Linha, Coluna, Diagonal).
   2. `BingoManagementService` salva referências em `BingoPadroes`.
   3. Ao iniciar a rodada, `GameService` carrega esses padrões para `_padroesDinamicosAtivos`.
   4. A cada bola sorteada, o sistema verifica se alguém completou *qualquer um* dos padrões ativos.
   5. Se completou "Linha", o padrão "Linha" é removido da lista ativa (já saiu), mas o jogo continua para os outros padrões (ex: Diagonal) até que todos saiam ou o operador encerre.

8. BANCO DE DADOS (ESQUEMA FÍSICO)
----------------------------------
O banco SQLite `bingo.db` contém as seguintes tabelas principais:
- Bingos
- Rodadas
- Combos
- Cartelas
- Padroes
- BingoPadroes
- Ganhadores
- Sorteios
- PedraMaiorSorteios
- DesempateItens
- Despesas (Tabela isolada para módulo financeiro)

9. CONCLUSÃO
------------
O sistema está completo e robusto, cobrindo desde a geração matemática segura de cartelas até a gestão complexa de jogos com múltiplos padrões simultâneos. A arquitetura permite escalabilidade e manutenção fácil, com separação clara entre UI e Regras de Negócio.

Este documento reflete o estado atual do código em 02/12/2025.
